<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{{ settings.software_name }}</title>
  <link href="/static/css/tailwind.css" rel="stylesheet">
  <link href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
  <style>
    .dropzone {
      border: 2px dashed #007bff;
      border-radius: 5px;
      background: #f9f9f9;
      padding: 50px;
      text-align: center;
      font-size: 18px;
      color: #007bff;
      cursor: pointer;
      margin-top: 20px;
    }
    .dropzone.dragover {
      background: #e9e9e9;
    }
  </style>
</head>
<body class="bg-gray-100 text-gray-900">
  <nav class="bg-gray-800 p-4">
    <div class="container mx-auto flex justify-between items-center">
      <a class="text-white text-lg font-bold" href="/">{{ settings.software_name }}</a>
      <div class="flex space-x-4">
        <a class="text-gray-300 hover:text-white" href="/">Accueil</a>
        <a class="text-gray-300 hover:text-white" href="#" data-toggle="modal" data-target="#aboutModal">À propos</a>
        <a class="text-gray-300 hover:text-white" href="#" data-toggle="modal" data-target="#contactModal">Contact</a>
      </div>
    </div>
  </nav>
  <div class="container mt-4">
    <h1 class="text-center">{{ settings.title_upload_file }}</h1>
    <form id="uploadForm" method="post" action="/upload" enctype="multipart/form-data">
      {{ form.hidden_tag() }}
      <div class="form-group">
        <label for="file">Choisissez un fichier :</label>
        {{ form.file(class="form-control d-none") }}
      </div>
      <div class="dropzone" id="dropzone">
        <p>Glissez-déposez vos fichiers ici ou cliquez pour sélectionner un fichier</p>
        <p>(Taille maximale : {{ settings.max_file_size }} Mo)</p>
      </div>
      <div id="error-message" class="text-danger mt-2"></div>
      <div class="form-group">
        <label for="password">Mot de passe (optionnel) :</label>
        <input type="password" id="password" name="password" class="form-control" placeholder="Entrez un mot de passe pour protéger le fichier">
      </div>
      <div class="form-group">
        <label for="expiry">Durée de validité :</label>
        {{ form.expiry(class="form-control") }}
      </div>
      <div class="form-group">
        <label for="max_downloads">Nombre maximal de téléchargements :</label>
        {{ form.max_downloads(class="form-control") }}
      </div>
      {{ form.submit(class="btn btn-primary") }}
    </form>
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        <div class="mt-4">
          {% for category, message in messages %}
            <div class="alert alert-info">
              <span>{{ message }}</span>
              <button id="copyButton" class="btn btn-secondary btn-sm" onclick="copyToClipboard('{{ message }}')">Copier le lien</button>
            </div>
          {% endfor %}
        </div>
      {% endif %}
    {% endwith %}
  </div>

  <!-- Modal À propos -->
  <div class="modal fade" id="aboutModal" tabindex="-1" role="dialog" aria-labelledby="aboutModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="aboutModalLabel">À propos</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          Le but de ce site est de permettre le partage sécurisé de fichiers sensibles. Chaque fichier est protégé par un lien unique et peut être configuré pour expirer après une certaine durée.
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Fermer</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Contact -->
  <div class="modal fade" id="contactModal" tabindex="-1" role="dialog" aria-labelledby="contactModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="contactModalLabel">Contact</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          Pour toute question ou assistance, veuillez nous contacter à : <a href="mailto:{{ settings.contact_email }}">{{ settings.contact_email }}</a>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Fermer</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.4/dist/umd/popper.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
  <script>
    function copyToClipboard(text) {
      var tempInput = document.createElement('input');
      tempInput.value = text;
      document.body.appendChild(tempInput);
      tempInput.select();
      document.execCommand('copy');
      document.body.removeChild(tempInput);
      
      var copyButton = document.getElementById('copyButton');
      copyButton.innerText = 'Lien copié';
      copyButton.classList.remove('btn-secondary');
      copyButton.classList.add('btn-success');
    }

    // Gestion des événements de glisser-déposer
    var dropzone = document.getElementById('dropzone');
    var fileInput = document.querySelector('input[type="file"]');
    var maxFileSize = {{ settings.max_file_size }} * 1024 * 1024;  // Taille maximale en octets
    var errorMessage = document.getElementById('error-message');

    dropzone.addEventListener('dragover', function(e) {
      e.preventDefault();
      e.stopPropagation();
      dropzone.classList.add('dragover');
    });

    dropzone.addEventListener('dragleave', function(e) {
      e.preventDefault();
      e.stopPropagation();
      dropzone.classList.remove('dragover');
    });

    dropzone.addEventListener('drop', function(e) {
      e.preventDefault();
      e.stopPropagation();
      dropzone.classList.remove('dragover');
      var files = e.dataTransfer.files;
      
      if (files[0].size > maxFileSize) {
        errorMessage.textContent = 'Le fichier est trop volumineux. La taille maximale autorisée est de ' + {{ settings.max_file_size }} + ' Mo.';
        fileInput.value = '';  // Réinitialiser le champ de fichier
        dropzone.innerHTML = `<p>Glissez-déposez vos fichiers ici ou cliquez pour sélectionner un fichier</p><p>(Taille maximale : {{ settings.max_file_size }} Mo)</p>`;
      } else {
        errorMessage.textContent = '';
        fileInput.files = files;
        dropzone.innerHTML = `<p>${files[0].name}</p><p>(Taille maximale : {{ settings.max_file_size }} Mo)</p>`;
      }
    });

    dropzone.addEventListener('click', function() {
      fileInput.click();
    });

    fileInput.addEventListener('change', function() {
      var file = fileInput.files[0];
      if (file.size > maxFileSize) {
        errorMessage.textContent = 'Le fichier est trop volumineux. La taille maximale autorisée est de ' + {{ settings.max_file_size }} + ' Mo.';
        fileInput.value = '';  // Réinitialiser le champ de fichier
        dropzone.innerHTML = `<p>Glissez-déposez vos fichiers ici ou cliquez pour sélectionner un fichier</p><p>(Taille maximale : {{ settings.max_file_size }} Mo)</p>`;
      } else {
        errorMessage.textContent = '';
        dropzone.innerHTML = `<p>${file.name}</p><p>(Taille maximale : {{ settings.max_file_size }} Mo)</p>`;
      }
    });
  </script>
</body>
</html>
