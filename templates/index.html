<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{{ settings.software_name }}</title>
  <link href="/static/css/tailwind.css" rel="stylesheet">
  <link href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
  <style>
    .dropzone {
      border: 2px dashed #007bff;
      border-radius: 5px;
      background: #f9f9f9;
      padding: 50px;
      text-align: center;
      cursor: pointer;
    }
    .dropzone.dragover {
      background: #e0f7ff;
    }
  </style>
</head>
<body class="bg-gray-100 text-gray-900">
  <nav class="bg-gray-800 p-4">
    <div class="container mx-auto flex justify-between items-center">
      <a class="text-white text-lg font-bold" href="/">{{ settings.software_name }}</a>
      <div class="flex space-x-4">
        <a class="text-gray-300 hover:text-white" href="/">Accueil</a>
        <a class="text-gray-300 hover:text-white" href="#" data-toggle="modal" data-target="#aboutModal">À propos</a>
        <a class="text-gray-300 hover:text-white" href="#" data-toggle="modal" data-target="#contactModal">Contact</a>
      </div>
    </div>
  </nav>

  <div class="container mt-4">
    <h1 class="text-center">{{ settings.title_upload_file }}</h1>
    <form id="upload-form" method="post" enctype="multipart/form-data" action="/upload">
      {{ form.hidden_tag() }}
      <div class="form-group">
        {{ form.file.label(class="form-label") }}
        {{ form.file(class="form-control") }}
      </div>
      <div class="form-group">
        {{ form.password.label(class="form-label") }}
        {{ form.password(class="form-control") }}
      </div>
      <div class="form-group">
        {{ form.expiry.label(class="form-label") }}
        {{ form.expiry(class="form-control") }}
      </div>
      <div class="form-group">
        {{ form.max_downloads.label(class="form-label") }}
        {{ form.max_downloads(class="form-control") }}
      </div>
      <div class="text-center">
        {{ form.submit(class="btn btn-primary") }}
      </div>
    </form>

    <div class="mt-4 dropzone" id="dropzone">
      Glissez et déposez les fichiers ici ou cliquez pour télécharger. <br>
      <small>Taille maximale : {{ settings.max_file_size }} Mo</small>
    </div>

    <div id="upload-success" class="mt-4 alert alert-success" style="display: none;">
      Fichier téléversé avec succès. Lien de téléchargement : <a id="download-link" href="#" target="_blank"></a>
      <button id="copy-link-btn" class="btn btn-secondary ml-2">Copier le lien</button>
    </div>
  </div>

  <!-- Modal À propos -->
  <div class="modal fade" id="aboutModal" tabindex="-1" role="dialog" aria-labelledby="aboutModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="aboutModalLabel">À propos</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          Le but de ce site est de permettre le partage sécurisé de fichiers sensibles. Chaque fichier est protégé par un lien unique, et peut être configuré pour expirer après une certaine durée ou un certain nombre de téléchargements.
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Fermer</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Contact -->
  <div class="modal fade" id="contactModal" tabindex="-1" role="dialog" aria-labelledby="contactModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="contactModalLabel">Contact</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          Pour toute question ou assistance, veuillez nous contacter à : <a href="mailto:{{ settings.contact_email }}">{{ settings.contact_email }}</a>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Fermer</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.4/dist/umd/popper.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      var dropzone = document.getElementById('dropzone');
      var uploadForm = document.getElementById('upload-form');
      var uploadSuccess = document.getElementById('upload-success');
      var downloadLink = document.getElementById('download-link');
      var copyLinkBtn = document.getElementById('copy-link-btn');

      dropzone.addEventListener('dragover', function (e) {
        e.preventDefault();
        dropzone.classList.add('dragover');
      });

      dropzone.addEventListener('dragleave', function (e) {
        dropzone.classList.remove('dragover');
      });

      dropzone.addEventListener('drop', function (e) {
        e.preventDefault();
        dropzone.classList.remove('dragover');
        var files = e.dataTransfer.files;
        if (files.length > 0) {
          var formData = new FormData(uploadForm);
          formData.append('file', files[0]);
          fetch('/upload', {
            method: 'POST',
            body: formData
          }).then(response => response.json()).then(data => {
            if (data.success) {
              uploadSuccess.style.display = 'block';
              downloadLink.href = data.link;
              downloadLink.textContent = data.link;
            } else {
              alert('Erreur lors du téléversement du fichier.');
            }
          }).catch(error => {
            console.error('Error:', error);
          });
        }
      });

      dropzone.addEventListener('click', function () {
        document.querySelector('input[type="file"]').click();
      });

      document.querySelector('input[type="file"]').addEventListener('change', function () {
        uploadForm.submit();
      });

      copyLinkBtn.addEventListener('click', function () {
        var link = downloadLink.href;
        navigator.clipboard.writeText(link).then(function () {
          copyLinkBtn.textContent = 'Lien copié';
          copyLinkBtn.classList.add('btn-success');
        }, function (err) {
          console.error('Erreur lors de la copie du lien : ', err);
        });
      });
    });
  </script>
</body>
</html>
